---
title: "student-success-analysis"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rlang)
library(tidyverse)
library(styler)
library(fastDummies)
styler::style_dir() # Style the current file so it's well formated
message("Your current working directory is: ", getwd())
```


## Data loading and getting the feeling of the dataset

```{r, colapse=TRUE}
students_org <- readxl::read_excel("student_data.xlsx")

# 370 rows, 39 columns
dim(students_org)

# Show column names
names(students_org)
```
```{r, colapse=TRUE}
# Show first few rows
head(students_org)
```


```{r, colapse=TRUE}
# Show details for each column
summary(students_org)
```


```{r, colapse=TRUE}
# Check the class of the column. "numeric", "character"...
sapply(students_org, class)
```

```{r, colapse=TRUE}

# Let's check if any columns exceed the maximum or minumum values specified in the pdf
# This makes sense only for numerical values

colMax <- students_org %>%
  select(where(is.numeric)) %>%
  sapply(., max, na.rm = TRUE)
colMax

# Every column has normal maximum value
```




```{r, colapse=TRUE}
# Are there any na values?
students_org %>% filter(is.na(.))
sum(apply(students_org, 2, is.nan))
students_org %>% filter(is.null(.))

# Drop these values just in case they show up with another dataset
# We will continue using "student" variable
students <- students_org %>% filter_all(all_vars(!is.na(.) & !is.nan(.) & !is.null(.)))
```

# Petar Dragojević
# zavisnost izmedu edukacije roditelja i uspješnosti
```{r}
#Mat_grade i Por_grade prebacivanje ocjena u engleski način ocjenjivanja
students <- students %>% mutate(Mat_grade =
                     case_when(G3_mat < 10 ~ "F", 
                               G3_mat >= 10 & G3_mat < 14 ~ "C",
                               G3_mat >= 14 & G3_mat < 16 ~ "B",
                               G3_mat >= 16 ~ "A")
)
students <- students %>% mutate(Por_grade =
                     case_when(G3_por < 10 ~ "F", 
                               G3_por >= 10 & G3_mat < 14 ~ "C",
                               G3_por >= 14 & G3_mat < 16 ~ "B",
                               G3_por >= 16 ~ "A")
)

#MeduMod i FeduMod grupiranje edukacije roditelja u veće podgrupe 
students <- students %>% mutate(MeduMod =
                     case_when(Medu == "0" | Medu == "1" | Medu == "2" ~ "0", 
                               Medu == "3" ~ "1",
                               Medu == "4" ~ "2")
)
students <- students %>% mutate(FeduMod =
                     case_when(Fedu == "0" | Medu == "1" | Fedu == "2" ~ "0", 
                               Fedu == "3" ~ "1",
                               Fedu == "4" ~ "2")
)

#za edukaciju roditelja uzimamo onu koja je veća
students$highestparentedu <- pmax(students$MeduMod, students$FeduMod)

boxplot(students$G3_mat[students$MeduMod=="0"], students$G3_mat[students$MeduMod=="1"], students$G3_mat[students$MeduMod=="2"], students$G3_mat[students$FeduMod=="0"], students$G3_mat[students$FeduMod=="1"], students$G3_mat[students$FeduMod=="2"], names = c("M/low", "M/middle", "M/high", "F/low", "F/middle", "F/high"),xlab="Mother/Father education",ylab="Mat final grade")

boxplot(students$G3_por[students$MeduMod=="0"], students$G3_por[students$MeduMod=="1"], students$G3_por[students$MeduMod=="2"], students$G3_por[students$FeduMod=="0"], students$G3_por[students$FeduMod=="1"], students$G3_por[students$FeduMod=="2"], names = c("M/low", "M/middle", "M/high", "F/low", "F/middle", "F/high"),xlab="Mother/Father education",ylab="Por final grade")

boxplot(students$G3_mat[students$highestparentedu=="0"], students$G3_mat[students$highestparentedu=="1"], students$G3_mat[students$highestparentedu=="2"], names = c("low", "middle", "high"),xlab="Highest parent education",ylab="Mat final grade")

boxplot(students$G3_por[students$highestparentedu=="0"], students$G3_por[students$highestparentedu=="1"], students$G3_por[students$highestparentedu=="2"], names = c("low", "middle", "high"),xlab="Highest parent education",ylab="Por final grade")

```

```{r}
#H0: Ocjena iz matematike i edukacija više educiranog roditelja su nezavisna obilježja
#H1: Ocjena iz matematike i edukacija više educiranog roditelja su zavisna obilježja

tbl = table(students$highestparentedu, students$Mat_grade)
added_margins_tbl = addmargins(tbl)
print(added_margins_tbl)
chisq.test(tbl,correct=F)
```
p-value testa iznosi manje od 0.05 stoga odbacujemo hipotezu H0, te zaključujemo da su edukacija više educiranog roditelja i završna ocjena iz matematike zavisne.

```{r}
#H0: Ocjena iz matematike i edukacija majke su nezavisna obilježja
#H1: Ocjena iz matematike i edukacija majke su zavisna obilježja
tbl = table(students$MeduMod, students$Mat_grade)
added_margins_tbl = addmargins(tbl)
print(added_margins_tbl)
chisq.test(tbl,correct=F)

#H0: Ocjena iz matematike i edukacija oca su nezavisna obilježja
#H1: Ocjena iz matematike i edukacija oca su zavisna obilježja
tbl2 = table(students$FeduMod, students$Mat_grade)
added_margins_tbl2 = addmargins(tbl2)
print(added_margins_tbl2)
chisq.test(tbl2,correct=F)
```

p-value Testa nezavisnosti iznosi manje od 0.05 stoga odbacujemo hipotezu H0, te zaključujemo da su edukacija majke i završna ocjena iz matematike zavisne, dok do tog zaključka ne možemo doći u slučaju edukacije oca.

```{r}
#H0: Ocjena iz portugala i edukacija više educiranog roditelja su nezavisna obilježja
#H1: Ocjena iz portugala i edukacija više educiranog roditelja su zavisna obilježja
tbl = table(students$highestparentedu, students$Por_grade)
added_margins_tbl = addmargins(tbl)
print(added_margins_tbl)
chisq.test(tbl,correct=F)

#očekivane frekvencije svih razreda moraju biti veće ili jednake 5
for (col_names in colnames(added_margins_tbl)){
  for (row_names in rownames(added_margins_tbl)){
    if (!(row_names == 'Sum' | col_names == 'Sum') ){
      cat('Očekivane frekvencije za razred ',col_names,'-',row_names,': ',(added_margins_tbl[row_names,'Sum'] * added_margins_tbl['Sum',col_names]) / added_margins_tbl['Sum','Sum'],'\n')
    }
  }
}
#Vidimo da postoje očekivane frekvencije manje od 5 pa koristimo fisher.test() umjesto chiq.test()
fisher.test(tbl)
```

chisq.test je nepouzdan pošto su očekivane frekvencije pojedinih  razreda manje od 5, radi toga koristimo fisher.test. p-value Fesherovog testa iznosi manje od 0.05 stoga odbacujemo hipotezu H0, te zaključujemo da su edukacija više educiranog roditelja i završna ocjena iz portigala zavisne.

```{r}
#H0: Ocjena iz portugala i edukacija majke su nezavisna obilježja
#H1: Ocjena iz portugala i edukacija majke su zavisna obilježja
tbl = table(students$MeduMod, students$Por_grade)
added_margins_tbl = addmargins(tbl)
print(added_margins_tbl)
chisq.test(tbl,correct=F)

#H0: Ocjena iz portugala i edukacija oca su nezavisna obilježja
#H1: Ocjena iz portugala i edukacija oca su zavisna obilježja
tbl2 = table(students$FeduMod, students$Por_grade)
added_margins_tbl2 = addmargins(tbl2)
print(added_margins_tbl2)
chisq.test(tbl2,correct=F)
#očekivane frekvencije svih razreda moraju biti veće ili jednake 5
for (col_names in colnames(added_margins_tbl2)){
  for (row_names in rownames(added_margins_tbl2)){
    if (!(row_names == 'Sum' | col_names == 'Sum') ){
      cat('Očekivane frekvencije za razred ',col_names,'-',row_names,': ',(added_margins_tbl2[row_names,'Sum'] * added_margins_tbl2['Sum',col_names]) / added_margins_tbl2['Sum','Sum'],'\n')
    }
  }
}
#Vidimo da postoje očekivane frekvencije manje od 5 pa koristimo fisher.test() umjesto chiq.test()
fisher.test(tbl)
```

p-value Testa nezavisnosti iznosi manje od 0.05 stoga odbacujemo hipotezu H0, te zaključujemo da su edukacija majke i završna ocjena iz portugala zavisne, kod usporedbe s edukacijom oca koristimo Fisherov test gdje je p-value manji od 0.05 pa odbacujemo H0 i zaključujemo da su edukacija oca i završna ocjena iz portugala zavisne.


## Tomislav Prhat

1. Jesu li učenici uspješniji u matematici ili glavnom jeziku?

```{r}

students_org  %>% summarise(
          Mean.G1_mat = mean(G1_mat),
          Mean.G2_mat = mean(G2_mat),
          Mean.G3_mat = mean(G3_mat),
          Mean.G1_por = mean(G1_por),
          Mean.G2_por = mean(G2_por),
          Mean.G3_por = mean(G3_por),
            ) -> summary.result1
summary.result1

students_org  %>% summarise(
          Med.G1_mat = median(G1_mat),
          Med.G2_mat = median(G2_mat),
          Med.G3_mat = median(G3_mat),
          Med.G1_por = median(G1_por),
          Med.G2_por = median(G2_por),
          Med.G3_por = median(G3_por),
            ) -> summary.result2
summary.result2

students_org  %>% summarise(
          Mean.G1_mat = mean(G1_mat, trim = 0.1),
          Mean.G2_mat = mean(G2_mat, trim = 0.1),
          Mean.G3_mat = mean(G3_mat, trim = 0.1),
          Mean.G1_por = mean(G1_por, trim = 0.1),
          Mean.G2_por = mean(G2_por, trim = 0.1),
          Mean.G3_por = mean(G3_por, trim = 0.1),
            ) -> summary.result3
summary.result3

(1 - summary.result3/summary.result1)*100

```

Kao što je vidljivo iz podataka, učenici su malo uspješniji u glavnom jeziku (portugalskom), ali ako gleda prema samoj ocjeni obje skupine spadaju u ocjenu "C". Čak i ako uzmemo podrezanu srednju vrijednost (10%), rezultat se promijeni za ~1%.


```{r}

students_org  %>% summarise(
          IQR.G1_mat = IQR(G1_mat),
          IQR.G2_mat = IQR(G2_mat),
          IQR.G3_mat = IQR(G3_mat),
          IQR.G1_por = IQR(G1_por),
          IQR.G2_por = IQR(G2_por),
          IQR.G3_por = IQR(G3_por),
            ) -> summary.result4
summary.result4

students_org  %>% summarise(
          Var.G1_mat = var(G1_mat),
          Var.G2_mat = var(G2_mat),
          Var.G3_mat = var(G3_mat),
          Var.G1_por = var(G1_por),
          Var.G2_por = var(G2_por),
          Var.G3_por = var(G3_por),
            ) -> summary.result5
summary.result5


students_org  %>% summarise(
          sd.G1_mat = sd(G1_mat),
          sd.G2_mat = sd(G2_mat),
          sd.G3_mat = sd(G3_mat),
          sd.G1_por = sd(G1_por),
          sd.G2_por = sd(G2_por),
          sd.G3_por = sd(G3_por),
            ) -> summary.result6
summary.result6

```

Ako gledamo raspršenost varijabli vidimo da ocjene iz portugalskog jezika imaju manje sve tri mjere (IQR, varijanca i standardna devijacija) vidimo da se ocjene iz portugalskog manje manje odmiču od srednje vrijednosti nego ocjene iz matematike.


## Matej Ciglenečki
```{r, colapse=TRUE}
# Show average grade for all schools

schools <- students %>%
  select("school") %>%
  distinct(.)
schools # [GP, MS]
subject_final_grade_names <- names(students)[grepl("G3", names(students))]
subject_final_grade_names
students_final_grade <- students %>% select("school", subject_final_grade_names)

# Select only the subject grade and school
gp_mat <- students_final_grade %>%
  filter(school == "GP") %>%
  select(G3_mat, school)
gp_por <- students_final_grade %>%
  filter(school == "GP") %>%
  select(G3_por, school)
ms_mat <- students_final_grade %>%
  filter(school == "MS") %>%
  select(G3_mat, school)
ms_por <- students_final_grade %>%
  filter(school == "MS") %>%
  select(G3_por, school)

# Rename all columns to "grade"
gp_mat <- gp_mat %>% rename(grade = G3_mat)
gp_por <- gp_por %>% rename(grade = G3_por)
ms_mat <- ms_mat %>% rename(grade = G3_mat)
ms_por <- ms_por %>% rename(grade = G3_por)


# TODO: can this data be grouped and used dynamically? (support multiple schools and mutliple subjects)

# scale_this <- function(x){
#   (x - mean(x, na.rm=TRUE)) / sd(x, na.rm=TRUE)
# }

# gp_mat_scaled <- gp_mat %>% mutate(G3_mat = scale_this(G3_mat))
# gp_por_scaled <- gp_por %>% mutate(G3_por = scale_this(G3_por))
# ms_mat_scaled <- ms_mat %>% mutate(G3_mat = scale_this(G3_mat))
# ms_por_scaled <- ms_por %>% mutate(G3_por = scale_this(G3_por))
```

```{r, colapse=TRUE}
# Plot math -- final grade
ggplot(gp_mat, aes(x = grade, y = (..count.. / sum(..count..)))) +
  geom_histogram(bins = 20, aes(color = school, fill = school), alpha = 0.5) +
  geom_histogram(data = ms_mat, bins = 20, aes(color = school, fill = school), alpha = 0.3) +
  geom_vline(data = gp_mat, aes(xintercept = mean(grade), color = school), linetype = "dashed") +
  geom_vline(data = ms_mat, aes(xintercept = mean(grade), color = school), linetype = "dashed") +
  xlab("Grade") +
  ylab("Relative frequency") +
  labs(title = "Mathematics - final grade for each school")

# Plot portug -- final grade
ggplot(gp_por, aes(x = grade, y = (..count.. / sum(..count..)))) +
  geom_histogram(bins = 20, aes(color = school, fill = school), alpha = 0.5) +
  geom_histogram(data = ms_por, bins = 20, aes(color = school, fill = school), alpha = 0.3) +
  geom_vline(data = gp_por, aes(xintercept = mean(grade), color = school), linetype = "dashed") +
  geom_vline(data = ms_por, aes(xintercept = mean(grade), color = school), linetype = "dashed") +
  xlab("Grade") +
  ylab("Relative frequency") +
  labs(title = "Portuguese - final grade for each school")
```

```{r, colapse=TRUE}
## Additional check for normailty is done with qqnorm
qqnorm(gp_mat$grade, pch = 1, frame = FALSE, main = "GP school math")
qqnorm(gp_por$grade, pch = 1, frame = FALSE, main = "GP school portuguese")
qqnorm(ms_mat$grade, pch = 1, frame = FALSE, main = "MS school math")
qqnorm(ms_por$grade, pch = 1, frame = FALSE, main = "MS school portuguese")
```


# F-test of variance equality
Argument order for F-test of variance equality doesn't matter but in general:
$$\frac{\sigma_{1}^2}{\sigma_{2}^2},\quad\sigma_{1}^2 > \sigma_{2}^2$$

$p \textemdash$ probability that under the null hypothesis of obtaining the value (of the test statistic) that's as extreme (or more extreme) than the value we got computed from the sample we have


If $p < \alpha$ we are rejecting the hypothesis $H0$ in favor of $H1$
  - falls under right tail => rejection

```{r, colapse=TRUE}

# Let's check variances just as a sanity check:
cat("Mathematics variances", var(gp_mat$grade), var(ms_mat$grade))
cat("Portugeuse variances", var(gp_por$grade), var(ms_por$grade))

# At first glance, it seems that we will probably reject H0 hypothesis for F-test in the case of Portuguese, as variances are vastly different.
alpha <- 0.05

# H0 - Variance of GP_MAT and MS_MAT are equal
# H1 - not H0
mat_f_test <- var.test(gp_mat$grade, ms_mat$grade, alternative = "two.sided") # F = 1.0752, p = 0.817
mat_f_test

# H0 - Variance of GP_POR and MS_MAT are equal
# H1 - not H0
por_f_test <- var.test(gp_por$grade, ms_por$grade, alternative = "two.sided") # F = 1.0752, p = 0.817
por_f_test
```

```{r, colapse=TRUE}
# This part won't be outputed as code in PDF

cat_reject_h0 <- function(prefix_message, is_h0_rejected) {
  cat(prefix_message, "\n")
  if (is_h0_rejected) cat("\tWe are rejecting the H0 hypothesis in favor of hypothesis H1\n") else cat("\tWe are not rejecting the H0 hypothesis\n")
}

var_equal_mat <- if (mat_f_test$p.value < alpha) FALSE else TRUE
cat_reject_h0("For mathemathics variance test:", !var_equal_mat)

var_equal_por <- if (por_f_test$p.value < alpha) FALSE else TRUE
cat_reject_h0("For Portuguese variance test:", !var_equal_por)
```

# T-test for grade equality
```{r, collapse=TRUE}
var_equal_mat
var_equal_por

# H0 - GP school has equal grades to in mathematics to MS (GP=MS)
# H1 - GP>MS
mat_t_test <- t.test(gp_mat$grade, ms_mat$grade, alt = "greater", var.equal = var_equal_mat)
is_gp_mat_better <- if (mat_t_test$p.value < alpha) TRUE else FALSE
cat_reject_h0("Mathemathics T-test test:", is_gp_mat_better)

# H0 - GP school has equal grades to in Portuguese to MS (GP=MS)
# H1 - GP>MS
por_t_test <- t.test(gp_por$grade, ms_por$grade, alt = "greater", var.equal = var_equal_por)
is_gp_por_better <- if (por_t_test$p.value < alpha) TRUE else FALSE
cat_reject_h0("Portuguese T-test test:", is_gp_por_better)
```
